<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”Ÿäº§ç¯å¢ƒè¯Šæ–­</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #d4af37;
      border-bottom: 2px solid #d4af37;
      padding-bottom: 10px;
    }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 4px solid #d4af37;
    }
    .test-section h2 {
      color: #d4af37;
      margin-top: 0;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      margin: 5px 0;
      font-weight: bold;
    }
    .status.success {
      background: #10b981;
      color: white;
    }
    .status.error {
      background: #ef4444;
      color: white;
    }
    .status.warning {
      background: #f59e0b;
      color: white;
    }
    .log {
      background: #000;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #666;
      padding-left: 10px;
    }
    .log-entry.error {
      border-left-color: #ef4444;
      color: #ef4444;
    }
    .log-entry.success {
      border-left-color: #10b981;
      color: #10b981;
    }
    .log-entry.info {
      border-left-color: #3b82f6;
      color: #3b82f6;
    }
    button {
      background: #d4af37;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #c49d2f;
    }
    .info {
      color: #9ca3af;
      font-size: 14px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ç”Ÿäº§ç¯å¢ƒè¯Šæ–­å·¥å…·</h1>
  <p class="info">å½“å‰æ—¶é—´: <span id="current-time"></span></p>
  <p class="info">å½“å‰ URL: <span id="current-url"></span></p>
  <p class="info">User Agent: <span id="user-agent"></span></p>

  <div class="test-section">
    <h2>1. åŸºç¡€ç¯å¢ƒæ£€æµ‹</h2>
    <div id="env-test"></div>
  </div>

  <div class="test-section">
    <h2>2. DOM å…ƒç´ æ£€æµ‹</h2>
    <div id="dom-test"></div>
  </div>

  <div class="test-section">
    <h2>3. JavaScript æ¨¡å—åŠ è½½æµ‹è¯•</h2>
    <div id="module-test"></div>
  </div>

  <div class="test-section">
    <h2>4. Supabase è¿æ¥æµ‹è¯•</h2>
    <div id="supabase-test"></div>
  </div>

  <div class="test-section">
    <h2>5. æŒ‰é’®åŠŸèƒ½æµ‹è¯•</h2>
    <button id="test-calendar-btn">æµ‹è¯•æŸ¥çœ‹é—²å¿™æŒ‰é’®</button>
    <button id="test-address-btn">æµ‹è¯•è·¯çº¿æŒ‡å¼•æŒ‰é’®</button>
    <button id="test-wechat-btn">æµ‹è¯•å¾®ä¿¡äºŒç»´ç æŒ‰é’®</button>
    <div id="button-test"></div>
  </div>

  <div class="test-section">
    <h2>6. æ§åˆ¶å°æ—¥å¿—</h2>
    <div id="console-log" class="log"></div>
  </div>

  <script>
    // æ‹¦æˆªæ§åˆ¶å°è¾“å‡º
    const consoleLog = document.getElementById('console-log');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleLog.appendChild(entry);
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addLog(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addLog('ERROR: ' + args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addLog('WARN: ' + args.join(' '), 'warning');
    };

    // æ•è·æœªå¤„ç†çš„é”™è¯¯
    window.addEventListener('error', (e) => {
      addLog(`æœªæ•è·çš„é”™è¯¯: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      addLog(`æœªå¤„ç†çš„ Promise æ‹’ç»: ${e.reason}`, 'error');
    });

    // æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
    document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN');
    document.getElementById('current-url').textContent = window.location.href;
    document.getElementById('user-agent').textContent = navigator.userAgent;

    console.log('è¯Šæ–­å·¥å…·å·²å¯åŠ¨');

    // æµ‹è¯• 1: åŸºç¡€ç¯å¢ƒ
    function testEnvironment() {
      const envTest = document.getElementById('env-test');
      let html = '';

      const tests = [
        { name: 'ES6 æ¨¡å—æ”¯æŒ', test: () => typeof Symbol !== 'undefined' },
        { name: 'Fetch API æ”¯æŒ', test: () => typeof fetch !== 'undefined' },
        { name: 'Promise æ”¯æŒ', test: () => typeof Promise !== 'undefined' },
        { name: 'async/await æ”¯æŒ', test: () => {
          try {
            eval('(async () => {})');
            return true;
          } catch (e) {
            return false;
          }
        }},
        { name: 'localStorage å¯ç”¨', test: () => {
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
          } catch (e) {
            return false;
          }
        }}
      ];

      tests.forEach(({ name, test }) => {
        const result = test();
        html += `<div class="status ${result ? 'success' : 'error'}">${result ? 'âœ“' : 'âœ—'} ${name}</div><br>`;
        console.log(`${name}: ${result ? 'é€šè¿‡' : 'å¤±è´¥'}`);
      });

      envTest.innerHTML = html;
    }

    // æµ‹è¯• 2: DOM å…ƒç´ 
    function testDOM() {
      const domTest = document.getElementById('dom-test');
      let html = '';

      const elements = [
        { id: 'view-calendar-btn', name: 'æŸ¥çœ‹é—²å¿™æŒ‰é’®' },
        { id: 'view-address-btn-hero', name: 'è·¯çº¿æŒ‡å¼•æŒ‰é’®(Hero)' },
        { id: 'view-address-btn', name: 'è·¯çº¿æŒ‡å¼•æŒ‰é’®(Footer)' },
        { id: 'view-wechat-btn', name: 'å¾®ä¿¡äºŒç»´ç æŒ‰é’®' },
        { id: 'calendar-modal', name: 'æ—¥å†æ¨¡æ€æ¡†' },
        { id: 'address-modal', name: 'åœ°å€æ¨¡æ€æ¡†' },
        { id: 'wechat-modal', name: 'å¾®ä¿¡æ¨¡æ€æ¡†' }
      ];

      elements.forEach(({ id, name }) => {
        const element = document.getElementById(id);
        const exists = !!element;
        html += `<div class="status ${exists ? 'success' : 'error'}">${exists ? 'âœ“' : 'âœ—'} ${name} (${id})</div><br>`;
        console.log(`${name}: ${exists ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
      });

      domTest.innerHTML = html;
    }

    // æµ‹è¯• 3: æ¨¡å—åŠ è½½
    async function testModules() {
      const moduleTest = document.getElementById('module-test');
      moduleTest.innerHTML = '<div class="status warning">â³ æ­£åœ¨æµ‹è¯•...</div>';

      try {
        console.log('å°è¯•åŠ è½½ supabase-client.js...');
        const supabaseModule = await import('./js/supabase-client.js');
        console.log('supabase-client.js åŠ è½½æˆåŠŸ');

        console.log('å°è¯•åŠ è½½ main.js...');
        const mainModule = await import('./js/main.js');
        console.log('main.js åŠ è½½æˆåŠŸ');

        moduleTest.innerHTML = `
          <div class="status success">âœ“ supabase-client.js åŠ è½½æˆåŠŸ</div><br>
          <div class="status success">âœ“ main.js åŠ è½½æˆåŠŸ</div><br>
          <div class="info">Supabase å®¢æˆ·ç«¯: ${supabaseModule.supabase ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</div>
        `;
      } catch (error) {
        console.error('æ¨¡å—åŠ è½½å¤±è´¥:', error);
        moduleTest.innerHTML = `
          <div class="status error">âœ— æ¨¡å—åŠ è½½å¤±è´¥</div><br>
          <div class="info">é”™è¯¯ä¿¡æ¯: ${error.message}</div>
          <div class="info">é”™è¯¯å †æ ˆ: <pre>${error.stack}</pre></div>
        `;
      }
    }

    // æµ‹è¯• 4: Supabase è¿æ¥
    async function testSupabase() {
      const supabaseTest = document.getElementById('supabase-test');
      supabaseTest.innerHTML = '<div class="status warning">â³ æ­£åœ¨æµ‹è¯•...</div>';

      try {
        console.log('å°è¯•è¿æ¥ Supabase...');
        const { supabase } = await import('./js/supabase-client.js');

        console.log('å°è¯•æŸ¥è¯¢æ•°æ®åº“...');
        const { data, error } = await supabase
          .from('guitar_repairs')
          .select('id')
          .limit(1);

        if (error) {
          throw error;
        }

        console.log('Supabase è¿æ¥æˆåŠŸ');
        supabaseTest.innerHTML = `
          <div class="status success">âœ“ Supabase è¿æ¥æˆåŠŸ</div><br>
          <div class="info">æŸ¥è¯¢ç»“æœ: ${data ? data.length + ' æ¡è®°å½•' : 'æ— æ•°æ®'}</div>
        `;
      } catch (error) {
        console.error('Supabase è¿æ¥å¤±è´¥:', error);
        supabaseTest.innerHTML = `
          <div class="status error">âœ— Supabase è¿æ¥å¤±è´¥</div><br>
          <div class="info">é”™è¯¯ä¿¡æ¯: ${error.message}</div>
        `;
      }
    }

    // æµ‹è¯• 5: æŒ‰é’®åŠŸèƒ½
    function testButtons() {
      const buttonTest = document.getElementById('button-test');
      let html = '<div class="info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•...</div>';
      buttonTest.innerHTML = html;

      // æµ‹è¯•æŸ¥çœ‹é—²å¿™æŒ‰é’®
      document.getElementById('test-calendar-btn').addEventListener('click', () => {
        console.log('æµ‹è¯•æŸ¥çœ‹é—²å¿™æŒ‰é’®...');
        const btn = document.getElementById('view-calendar-btn');
        const modal = document.getElementById('calendar-modal');

        if (!btn) {
          buttonTest.innerHTML += '<div class="status error">âœ— æŸ¥çœ‹é—²å¿™æŒ‰é’®ä¸å­˜åœ¨</div><br>';
          return;
        }

        if (!modal) {
          buttonTest.innerHTML += '<div class="status error">âœ— æ—¥å†æ¨¡æ€æ¡†ä¸å­˜åœ¨</div><br>';
          return;
        }

        // æ¨¡æ‹Ÿç‚¹å‡»
        btn.click();

        setTimeout(() => {
          const isVisible = modal.style.display === 'block';
          buttonTest.innerHTML += `<div class="status ${isVisible ? 'success' : 'error'}">${isVisible ? 'âœ“' : 'âœ—'} æŸ¥çœ‹é—²å¿™æŒ‰é’®: ${isVisible ? 'æ­£å¸¸' : 'å¤±è´¥'}</div><br>`;
          console.log(`æŸ¥çœ‹é—²å¿™æŒ‰é’®æµ‹è¯•: ${isVisible ? 'é€šè¿‡' : 'å¤±è´¥'}`);

          if (isVisible) {
            modal.style.display = 'none';
          }
        }, 100);
      });

      // æµ‹è¯•è·¯çº¿æŒ‡å¼•æŒ‰é’®
      document.getElementById('test-address-btn').addEventListener('click', () => {
        console.log('æµ‹è¯•è·¯çº¿æŒ‡å¼•æŒ‰é’®...');
        const btn = document.getElementById('view-address-btn-hero');
        const modal = document.getElementById('address-modal');

        if (!btn) {
          buttonTest.innerHTML += '<div class="status error">âœ— è·¯çº¿æŒ‡å¼•æŒ‰é’®ä¸å­˜åœ¨</div><br>';
          return;
        }

        if (!modal) {
          buttonTest.innerHTML += '<div class="status error">âœ— åœ°å€æ¨¡æ€æ¡†ä¸å­˜åœ¨</div><br>';
          return;
        }

        // æ¨¡æ‹Ÿç‚¹å‡»
        btn.click();

        setTimeout(() => {
          const isVisible = modal.style.display === 'block';
          buttonTest.innerHTML += `<div class="status ${isVisible ? 'success' : 'error'}">${isVisible ? 'âœ“' : 'âœ—'} è·¯çº¿æŒ‡å¼•æŒ‰é’®: ${isVisible ? 'æ­£å¸¸' : 'å¤±è´¥'}</div><br>`;
          console.log(`è·¯çº¿æŒ‡å¼•æŒ‰é’®æµ‹è¯•: ${isVisible ? 'é€šè¿‡' : 'å¤±è´¥'}`);

          if (isVisible) {
            modal.style.display = 'none';
          }
        }, 100);
      });

      // æµ‹è¯•å¾®ä¿¡äºŒç»´ç æŒ‰é’®
      document.getElementById('test-wechat-btn').addEventListener('click', () => {
        console.log('æµ‹è¯•å¾®ä¿¡äºŒç»´ç æŒ‰é’®...');
        const btn = document.getElementById('view-wechat-btn');
        const modal = document.getElementById('wechat-modal');

        if (!btn) {
          buttonTest.innerHTML += '<div class="status error">âœ— å¾®ä¿¡äºŒç»´ç æŒ‰é’®ä¸å­˜åœ¨</div><br>';
          return;
        }

        if (!modal) {
          buttonTest.innerHTML += '<div class="status error">âœ— å¾®ä¿¡æ¨¡æ€æ¡†ä¸å­˜åœ¨</div><br>';
          return;
        }

        // æ¨¡æ‹Ÿç‚¹å‡»
        btn.click();

        setTimeout(() => {
          const isVisible = modal.style.display === 'block';
          buttonTest.innerHTML += `<div class="status ${isVisible ? 'success' : 'error'}">${isVisible ? 'âœ“' : 'âœ—'} å¾®ä¿¡äºŒç»´ç æŒ‰é’®: ${isVisible ? 'æ­£å¸¸' : 'å¤±è´¥'}</div><br>`;
          console.log(`å¾®ä¿¡äºŒç»´ç æŒ‰é’®æµ‹è¯•: ${isVisible ? 'é€šè¿‡' : 'å¤±è´¥'}`);

          if (isVisible) {
            modal.style.display = 'none';
          }
        }, 100);
      });
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function runAllTests() {
      console.log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
      testEnvironment();
      testDOM();
      await testModules();
      await testSupabase();
      testButtons();
      console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆ');
    }

    // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runAllTests);
    } else {
      runAllTests();
    }
  </script>
</body>
</html>
